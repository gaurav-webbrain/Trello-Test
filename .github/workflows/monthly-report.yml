name: Monthly Time Report

on:
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Fetch Issues
        run: |
          gh api \
            repos/${{ github.repository }}/issues \
            --paginate > issues.json

      - name: Create jq script
        run: |
          cat > jq-script.jq << 'EOF'
          .[] as $i
          | ($i.body | match("Start: ([0-9A-Za-z:+\\- ]+)"))? as $mstart
          | ($i.body | match("Stop: ([0-9A-Za-z:+\\- ]+)"))? as $mstop
          | if $mstart and $mstop then
              $i.number as $n |
              $i.title as $t |
              ($mstart.captures[0].string) as $start |
              ($mstop.captures[0].string) as $stop |
              (
                (
                  ($stop | fromdate)
                  -
                  ($start | fromdate)
                ) / 3600
              ) as $hours |
              "\($n),\"\($t)\",\($start),\($stop),\($hours)"
            else empty end
          EOF

      - name: Generate CSV Report
        run: |
          echo "Issue,Title,Start,Stop,Hours" > report.csv
          jq -r -f jq-script.jq issues.json >> report.csv

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: monthly-report
          path: report.csv

name: Monthly Report
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Fetch Issues
        run: |
          gh api \
            repos/gaurav-webbrain/Trello-Test/issues \
            --paginate \
            --jq '.' > issues.json
      - name: Generate CSV
        run: |
          echo "Issue,Title,Start,Stop,Hours" > report.csv
          jq -r '.[] | 
            select(.body | test("Start:.*Stop:")) |
            . as $i |
            (.body | capture("Start: (?<start>[0-9A-Za-z:+ -]+)") | .start) as $start |
            (.body | capture("Stop: (?<stop>[0-9A-Za-z:+ -]+)") | .stop) as $stop |
            "\($i.number),\"\($i.title)\",\($start),\($stop),\((($stop | fromdate) - ($start | fromdate)) / 3600)"
          ' issues.json >> report.csv
      - name: Upload CSV
        uses: actions/upload-artifact@v4
        with:
          name: monthly-report
          path: report.csv

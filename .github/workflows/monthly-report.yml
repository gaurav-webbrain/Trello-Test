name: Monthly Report
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Issues
        run: |
          gh api \
            repos/gaurav-webbrain/Trello-Test/issues \
            --paginate > issues.json

      - name: Debug - Show issues
        run: |
          echo "Total issues found:"
          jq 'length' issues.json
          echo "First issue body:"
          jq -r '.[0].body // "No body"' issues.json | head -20

      - name: Generate CSV
        run: |
          echo "Issue,Title,Start,Stop,Hours" > report.csv
          jq -r '
            .[] |
            select(.body != null) |
            . as $issue |

            # Extract Start (handles CR, LF, timezone, ISO8601)
            (.body | match("(?im)start\\s*[:\\-]\\s*(?<val>[^\\r\\n]+)") 
               | .captures[0].val 
               | gsub("\\s+$"; "")) as $start |

            # Extract Stop (same pattern)
            (.body | match("(?im)stop\\s*[:\\-]\\s*(?<val>[^\\r\\n]+)") 
               | .captures[0].val 
               | gsub("\\s+$"; "")) as $stop |

            try (
              "\($issue.number),\"\($issue.title)\",\($start),\($stop),\((($stop | fromdateiso8601) - ($start | fromdateiso8601)) / 3600)"
            ) catch (
              "\($issue.number),\"\($issue.title)\",\($start),\($stop),ERROR"
            )
          ' issues.json >> report.csv

      - name: Debug - Show CSV
        run: |
          echo "CSV contents:"
          cat report.csv
          echo "CSV line count:"
          wc -l report.csv

      - name: Upload CSV
        uses: actions/upload-artifact@v4
        with:
          name: monthly-report
          path: report.csv

name: Monthly Report
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Issues
        run: |
          gh api \
            repos/gaurav-webbrain/Trello-Test/issues \
            --paginate > issues.json

      - name: Debug - Show issues
        run: |
          echo "Total issues found:"
          jq 'length' issues.json
          echo "First issue body:"
          jq -r '.[0].body // "No body"' issues.json | head -20

      - name: Generate CSV
        run: |
          echo "Issue,Title,Start,Stop,Hours" > report.csv

          jq -r '
            .[] |
            . as $i |
            ($i.body
              | gsub("\\*"; "")
              | gsub("`"; "")
              | gsub("\r"; "")
              | gsub("\n"; " ")
              | gsub(" +"; " ")
            ) as $clean |
            
            ($clean | match("Start[:\\- ]+([0-9TZ:+\\- ]{8,32})")? | .captures[0].string) as $start |
            ($clean | match("Stop[:\\- ]+([0-9TZ:+\\- ]{8,32})")? | .captures[0].string) as $stop |
            
            ($start | fromdateiso8601? // 0) as $sEpoch |
            ($stop  | fromdateiso8601? // 0) as $eEpoch |
            
            ($eEpoch - $sEpoch) / 3600 as $hours |
            
            "\($i.number),\($i.title),\($start // ""),\($stop // ""),\($hours // "")"
          ' issues.json >> report.csv

      - name: Debug - Show CSV
        run: |
          echo "CSV contents:"
          cat report.csv
          echo "CSV line count:"
          wc -l report.csv

      - name: Upload CSV
        uses: actions/upload-artifact@v4
        with:
          name: monthly-report
          path: report.csv

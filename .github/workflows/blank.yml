monthly_report:
  name: Monthly Time Report
  runs-on: ubuntu-latest

  steps:
    - uses: actions/checkout@v4

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Fetch issues
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh api \
          repos/${{ github.repository }}/issues \
          --paginate \
          --jq '.[] | {number, title, body}' > issues.json

    - name: Build CSV
      run: |
        echo "Issue,Title,Start,Stop,Hours" > report.csv

        cat issues.json | jq -r '
          . as $i
          | ($i.body | capture("Start: (?<start>[0-9A-Za-z: +\\-]+)"))? as $s
          | ($i.body | capture("Stop: (?<stop>[0-9A-Za-z: +\\-]+)"))? as $e
          | if $s and $e then
              .number as $n |
              .title as $t |
              ($s.start) as $start |
              ($e.stop) as $stop |
              (
                (( ($e.stop | fromdate) - ($s.start | fromdate) ) / 3600)
              ) as $hours |
              "\($n),\"\($t)\",\($start),\($stop),\($hours)"
            else empty end
        ' >> report.csv

    - name: Upload report
      uses: actions/upload-artifact@v4
      with:
        name: monthly-time-report
        path: report.csv

name: Monthly Time Report

on:
  schedule:
    - cron: "0 0 1 * *"
  workflow_dispatch:

jobs:
  monthly_report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Set up GH CLI token
        run: echo "GH_TOKEN=${{ github.token }}" >> $GITHUB_ENV

      - name: Fetch Issues Into issues.json
        run: |
          gh api \
            repos/gaurav-webbrain/Trello-Test/issues \
            --paginate \
            --jq '.[]' > issues.json

      - name: Create CSV Header
        run: echo "IssueNumber,Title,Start,Stop,Hours" > report.csv

      - name: Build CSV
        run: |
          jq -r '
            .[] as $i
            | ($i.body | match("Start: ([0-9A-Za-z:+\\- ]+)"))? as $mstart
            | ($i.body | match("Stop: ([0-9A-Za-z:+\\- ]+)"))? as $mstop
            | if $mstart and $mstop then
                $i.number as $n |
                ($i.title | gsub("\""; "'\''")) as $t |
                ($mstart.captures[0].string) as $start |
                ($mstop.captures[0].string) as $stop |
                (
                  (
                    ( $stop | fromdate )
                    -
                    ( $start | fromdate )
                  ) / 3600
                ) as $hours |
                "\($n),\"\($t)\",\($start),\($stop),\($hours)"
              else empty end
          ' issues.json >> report.csv

      - name: Upload CSV Artifact
        uses: actions/upload-artifact@v4
        with:
          name: monthly-report
          path: report.csv
